#!/usr/bin/env python3
# This file is placed in the Public Domain.


"object programming bot"


import importlib
import os
import readline
import sys
import termios
import time


sys.path.insert(0, ".")


from opb.clients import Client
from opb.storage import Storage
from opb.threads import launch


import opb.modules


Storage.workdir = os.path.expanduser("~/.opb")


class Console(Client):

    def raw(self, txt):
        print(txt)
        sys.stdout.flush()

    def poll(self):
        return self.event(input("> "))

    def scan(self):
        path = opb.modules.__path__[0]
        for fnm in os.listdir(path):
            try:
                mod = importlib.import_module("." + fnm[:-3], "opb.modules")
            except ModuleNotFoundError:
               continue
            Client.scan(self, mod)
            if "init" in dir(mod):
                bot = mod.init()
                bot.clone(self)

    def wait(self):
        while 1:
            time.sleep(1.0)


def main():
    csl = Console()
    csl.scan()
    txt = " ".join(sys.argv[1:])
    if txt:
        return csl.one(txt)
    date = time.ctime(time.time()).replace("  ", " ")
    print(f"OPB started {date}")
    csl.loop()


if __name__ == "__main__":
    try:
        main()
    except (EOFError, KeyboardInterrupt):
        print("")
