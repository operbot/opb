#!/usr/bin/env python3
# This file is placed in the Public Domain.


"object programming bot"


import os
import sys
import termios
import time
import traceback


sys.path.insert(0, os.getcwd())


from opb.objects import Default, update
from opb.handler import Event, Handler
from opb.modules import cmd, fnd, irc, rss
from opb.storage import Storage


Cfg = Default()
Storage.workdir = os.path.expanduser("~/.opb")


class CLI(Handler):

    def __init__(self):
        Handler.__init__(self)
        self.register("command", self.dispatch)

    def announce(self, txt):
        pass

    def raw(self, txt):
        print(txt)
        sys.stdout.flush()


def wrap(func):
    try:
        func()
    except (EOFError, KeyboardInterrupt):
        print("")
    finally:
        for ex in Handler.errors:
            traceback.print_exception(type(ex), ex, ex.__traceback__)


def main():
    e = Event()
    e.type = "command"
    e.parse(" ".join(sys.argv[1:]))
    cli = CLI()
    cli.scan(cmd)
    cli.scan(fnd)
    cli.scan(irc)
    cli.scan(rss)
    cli.handle(e)


wrap(main)
