#!/usr/bin/env python3
# This file is placed in the Public Domain.


"object programming bot daemon"


import os
import sys
import termios
import time
import traceback


sys.path.insert(0, os.getcwd())


from opb.objects import Default, update
from opb.handler import Event, Handler
from opb.modules import cmd, fnd, irc, rss
from opb.runtime import launch
from opb.storage import Storage
from opb.utility import wait


Cfg = Default()
Storage.workdir = os.path.expanduser("~/.opb")


def daemon():
    pid = os.fork()
    if pid != 0:
        os._exit(0)
    os.setsid()
    os.umask(0)
    sis = open("/dev/null", 'r')
    os.dup2(sis.fileno(), sys.stdin.fileno())
    sos = open("/dev/null", 'a+')
    ses = open("/dev/null", 'a+')
    os.dup2(sos.fileno(), sys.stdout.fileno())
    os.dup2(ses.fileno(), sys.stderr.fileno())


def waiter():
    got = []
    for ex in Handler.errors:
        traceback.print_exception(type(ex), ex, ex.__traceback__)
        got.append(ex)
    for exc in got:
        Handler.errors.remove(exc)


def main():
    daemon()
    thr = launch(irc.init)
    bot = thr.join()
    bot.scan(cmd)
    bot.scan(rss)
    rss.init()
    wait(waiter)


main()
