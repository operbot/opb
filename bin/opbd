#!/usr/bin/env python3
# This file is placed in the Public Domain.


import os
import sys
import traceback


sys.path.insert(0, os.getcwd())


from opb import Cfg, Handler, Storage, privileges, scan, wait
from opb.modules import cmd, irc, rss


Storage.workdir = "/var/lib/opb/"


scan(cmd)
scan(rss)


def daemon():
    pid = os.fork()
    if pid != 0:
        os._exit(0)
    os.setsid()
    os.umask(0)
    sis = open("/dev/null", 'r')
    os.dup2(sis.fileno(), sys.stdin.fileno())
    sos = open("/dev/null", 'a+')
    ses = open("/dev/null", 'a+')
    os.dup2(sos.fileno(), sys.stdout.fileno())
    os.dup2(ses.fileno(), sys.stderr.fileno())


def waiter():
    got = []
    for ex in Handler.errors:
        traceback.print_exception(type(ex), ex, ex.__traceback__)
        got.append(ex)
    for exc in got:
        Handler.errors.remove(exc)


def main():
    daemon()
    #privileges("opb")
    irc.init()
    rss.init()
    wait(waiter)


main()
